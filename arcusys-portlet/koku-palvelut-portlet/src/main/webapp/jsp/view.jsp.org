<%@ include file="/jsp/init.jsp"%>
<%@ page contentType="text/html;charset=UTF-8" pageEncoding="UTF-8" isELIgnored="false" %>
<%@page import="fi.arcusys.koku.portlet.veera.model.VeeraCategory"%>
<%@page import="fi.arcusys.koku.portlet.veera.model.VeeraForm"%>
<%@page import="fi.arcusys.koku.portlet.veera.model.FormHolder"%>
<%@page import="java.util.List"%>
<%@page import="java.util.ArrayList"%>
<%@ page import="fi.arcusys.koku.portlet.veera.controller.ViewController"%>
<%@ page import="fi.arcusys.koku.portlet.veera.controller.EditController"%>
<%@ page import="com.liferay.portal.theme.ThemeDisplay"%>
<%@ page import="com.liferay.portal.kernel.security.permission.PermissionChecker"%>
<%@ page import="com.liferay.portal.service.CompanyLocalServiceUtil"%>
<%@ page import="com.liferay.portal.service.RoleLocalServiceUtil"%>
<%@ page import="com.liferay.portal.model.Company"%>
<% 

// Liferay ThemeDisplay object for getting user group
ThemeDisplay td = (ThemeDisplay) request.getAttribute("THEME_DISPLAY");
// test3.user group name
String adminGroup = "10204";

// Get current folder from request parameter (or attribute)
String folderId = request.getParameter(ViewController.VIEW_CURRENT_FOLDER);
if (folderId == null) {
	folderId = (String) request.getAttribute(EditController.CURRENT_CATEGORY);
	if (folderId == null) {
		folderId = "1";
	}
}

int currentFolder;
try {
	currentFolder = Integer.parseInt(folderId);
} catch (NumberFormatException e) {
	currentFolder = 1;
}

// Category currently selected
VeeraCategory currentCategory = VeeraCategory.getCategory(currentFolder);
if (currentCategory == null) {
	// If category doesn't exist
	currentCategory = VeeraCategory.getCategory(1);
}

// Child categories & forms of currently selected category
List<VeeraCategory> categories = (List<VeeraCategory>) VeeraCategory.getChildCategories(currentFolder);
List<VeeraForm> forms = (List<VeeraForm>) VeeraCategory.getChildFormsFiltered(currentFolder, (List<FormHolder>)session.getAttribute("tasklist"));

long userId = Long.parseLong(request.getRemoteUser());
long companyId = ((Company)CompanyLocalServiceUtil.getCompanies().get(0)).getCompanyId();		

boolean isAdmin = RoleLocalServiceUtil.hasUserRole(userId, companyId, "VeeraAdmin", true);

pageContext.setAttribute("veeraCategories", categories);
pageContext.setAttribute("veeraForms", forms);
pageContext.setAttribute("td", td);
pageContext.setAttribute("admin", adminGroup);
pageContext.setAttribute("isAdmin", isAdmin);
// Counter for table-style
int c = 0;

%>

<!-- 
User group name = ${td.user.group.name}
 -->

<div class="portlet-linkit-container">

	<!-- UI-messages -->
	<jsp:include page="/jsp/messages.jsp" />
	
	<!-- Portlet Header -->
	
	<div class="portlet-header">
		<h2>
			<jsp:include page="/jsp/breadCrumb.jsp" />
		</h2>
		
		<%// Admin actions 
		
				

		if (isAdmin == true) {
	
		%>
		
			
			<!-- Add URL Form Button -->
			<div class="btn_lisaa_linkki">
				<portlet:renderURL var="addURLFormURL"
					windowState="<%= WindowState.MAXIMIZED.toString() %>">
					<portlet:param name="action" value="edit" />
					<portlet:param name="<%= EditController.EDIT_TYPE %>" value="<%= EditController.SHOW_ADD_URL_FORM %>" />
					<portlet:param name="<%= EditController.CURRENT_CATEGORY %>" value="<%= currentCategory.getEntryId().toString() %>" />			 
				</portlet:renderURL>
				<button onclick="self.location = '${addURLFormURL}';" class="basic_w_icon" type="button">
				<span>
					<img class="icon_add_plus_small" src="/html/themes/okp01/images-custom/icon_add_plus_small.png"/>
					Lis�� lomakelinkki
				</span>
				</button>
			</div>
			<!-- Add Intalio Form Button -->
			<div class="btn_lisaa_linkki">
				<portlet:renderURL var="addIntalioFormURL"
					windowState="<%= WindowState.MAXIMIZED.toString() %>">
					<portlet:param name="action" value="edit" />
					<portlet:param name="<%= EditController.EDIT_TYPE %>" value="<%= EditController.SHOW_ADD_INTALIO_FORM %>" />
					<portlet:param name="<%= EditController.CURRENT_CATEGORY %>" value="<%= currentCategory.getEntryId().toString() %>" /> 
				</portlet:renderURL>
				<button onclick="self.location = '${addIntalioFormURL}';" class="basic_w_icon" type="button">
				<span>
					<img class="icon_add_plus_small" src="/html/themes/okp01/images-custom/icon_add_plus_small.png"/>
					Lis�� lomake
				</span>
				</button>
			</div>
			<!-- Add Category Button -->
			<div class="btn_luo_kansio">
				<portlet:renderURL var="addCategoryURL"
					windowState="<%= WindowState.MAXIMIZED.toString() %>">
					<portlet:param name="action" value="edit" />
					<portlet:param name="<%= EditController.EDIT_TYPE %>" value="<%= EditController.SHOW_ADD_CATEGORY %>" />
					<portlet:param name="<%= EditController.CURRENT_CATEGORY %>" value="<%= currentCategory.getEntryId().toString() %>" /> 
				</portlet:renderURL>
				<button onclick="self.location = '${addCategoryURL}';" class="basic_w_icon" type="button">
				<span>
					<img class="icon_add_plus_small" src="/html/themes/okp01/images-custom/icon_add_plus_small.png"/>
					 Luo kansio
				</span>
				</button>
			</div>
		<% } %>
		<div class="clearer"></div>
	</div>
	
	<!-- Portlet Content -->
	
	<div class="portlet-content">
	
	<!-- Categories listing -->
	<% if (categories.size() > 0) { %>
	<table class="taglib-search-iterator">
		<tbody>
			<tr class="portlet-section-header">
				<th>Kansio</th>
				<th>Nimi ja tiedot</th>
				<c:if test="${isAdmin == true}">
					<!-- Table header for Admin -->
					<th>Yll�pito</th>
				</c:if>
			</tr>
			<c:forEach var="veeraCategory" items="${veeraCategories}">
				<tr class="portlet-section-<%= c++ % 2 == 1 ? "body" : "alternate" %>">
					<td class="col-1" valign="middle" align="left">
						<a href="#">
							<img border="0" align="left" src="/html/themes/okp01/images-custom/symbol_folder.png"/>
						</a>
					</td>
					<td class="col-2" valign="middle" align="left">
						<div class="title">
							<portlet:renderURL var="folderViewURL"
								windowState="<%= WindowState.MAXIMIZED.toString() %>">
								<portlet:param name="<%= ViewController.VIEW_CURRENT_FOLDER %>" value="${veeraCategory.entryId}" />
							</portlet:renderURL>
														
							<a href="${folderViewURL}">
								<c:out value="${veeraCategory.name}" />
							</a>
						</div>
						<span class="details">
							<% /* List amount of categories & forms the category contains */
							   int catId = ((VeeraCategory)pageContext.getAttribute("veeraCategory")).getEntryId();
							   int childCategories = VeeraCategory.getChildCategories(catId).size();
							   int childForms = VeeraCategory.getChildForms(catId).size();
							if (childCategories > 0) { %>
								Kansioita: <%= childCategories %>
							<% }
							if (childForms > 0) { %>
								Lomakkeita: <%= childForms %>
							<% } 
							if (childCategories == 0 && childForms == 0) { %>
								Kansio on tyhj�. <%
							}
							%>
						</span>
					</td>
					<!-- Admin actions -->
					<%
					// Check that user is an admin
					%>
					<c:if test="${isAdmin == true}">
						<td class="col-3" valign="middle" align="right">					
							<div class="btn_container_admin_actions">
								<% String categoryId = Integer.toString(catId); %>
								<portlet:renderURL var="editCategoryURL"
									windowState="<%= WindowState.MAXIMIZED.toString() %>">
									<portlet:param name="action" value="edit" />
									<portlet:param name="<%= EditController.EDIT_TYPE %>" value="<%= EditController.SHOW_EDIT_CATEGORY %>" /> 
									<portlet:param name="editCategoryId" value="<%= categoryId %>" />
									<portlet:param name="<%= EditController.CURRENT_CATEGORY %>" value="<%= currentCategory.getEntryId().toString() %>" />
								</portlet:renderURL>
								<a href="${editCategoryURL}">
									<img src="/html/themes/okp01/images-custom/btn_edit.png" onmousemove="ToolTip.show(event, this, '\u004d\u0075\u006f\u006b\u006b\u0061\u0061\u0020\u006c\u0069\u006e\u006b\u006b\u0069\u00e4')" align="middle" border="0" />
								</a>
								<portlet:actionURL var="removeCategoryURL">
									<portlet:param name="action" value="edit" />
									<portlet:param name="<%= EditController.EDIT_TYPE %>" value="<%= EditController.ADMIN_REMOVE_CATEGORY_ACTION %>" />
									<portlet:param name="removeCategoryId" value="<%= categoryId %>" />
									<portlet:param name="<%= EditController.CURRENT_CATEGORY %>" value="<%= currentCategory.getEntryId().toString() %>" />
								</portlet:actionURL>
								<a href="${removeCategoryURL}">
									<img src="/html/themes/okp01/images-custom/btn_delete.png" onmousemove="ToolTip.show(event, this, '\u0050\u006f\u0069\u0073\u0074\u0061')" align="middle" border="0" />
								</a>
							</div>
						</td>
					</c:if>
				</tr>
			</c:forEach>
		</tbody>
	</table>
	<% } // Categories if ends %> 
	
	 <%
	   if (categories.size() > 0 && forms.size() > 0) {
	%>
	<!-- Separator for folders & forms -->
	<br /><br /><br />
	<% } %>
	
	
	<!-- Forms listing -->
	<% if (forms.size() > 0) { %>
	<table class="taglib-search-iterator">
		<tbody>
			<tr class="portlet-section-header">
				<th>Lomakkeen nimi</th>
				<th>URL</th>
				<c:if test="${isAdmin == true}">
					<!-- Table header for Admin -->
					<th>Yll�pito</th>
				</c:if>
			</tr>
			<c:forEach var="veeraForm" items="${veeraForms}">
				<tr class="portlet-section-<%= c++ % 2 == 1 ? "body" : "alternate" %>">
					<td valign="middle" align="left" class="col-1">
						<!-- URL to formview.jsp -->
						<portlet:renderURL var="formViewURL"
							windowState="<%= WindowState.MAXIMIZED.toString() %>">
							<portlet:param name="action" value="formview" />
							<portlet:param name="type" value="${veeraForm.type}" />
							<portlet:param name="identity" value="${veeraForm.identity}" />
							<portlet:param name="identity2" value="${veeraForm.identity2}" />
							<portlet:param name="<%= EditController.CURRENT_CATEGORY %>" value="<%= currentCategory.getEntryId().toString() %>" />
						</portlet:renderURL>
						<a href="${formViewURL}">
							${veeraForm.identity_64}
						</a>
					</td>
					<td valign="middle" align="left" class="col-2">
						<c:if test="${veeraForm.identity2 ne null}">
							<a href="${formViewURL}">
								${veeraForm.identity2_64}
							</a>
						</c:if>
					</td>
					<%
					// Check that user is an admin
					%>
					<c:if test="${isAdmin == true}">
						<td class="col-3" valign="middle" align="right">						
							<div class="btn_container_admin_actions">
								<% int formIdInt = ((VeeraForm)pageContext.getAttribute("veeraForm")).getEntryId();
								   String formId = Integer.toString(formIdInt);
								%>
								<% /* Show edit-button only for URL forms */ %>
								<c:if test="${veeraForm.type == '1'}">
									<portlet:renderURL var="editFormURL"
										windowState="<%= WindowState.MAXIMIZED.toString() %>">
										<portlet:param name="action" value="edit" />
										<portlet:param name="<%= EditController.EDIT_TYPE %>" value="<%= EditController.SHOW_EDIT_FORM %>" /> 
										<portlet:param name="formId" value="<%= formId %>" />
										<portlet:param name="<%= EditController.CURRENT_CATEGORY %>" value="<%= currentCategory.getEntryId().toString() %>" />
									</portlet:renderURL>
									<a href="${editFormURL}">
										<img src="/html/themes/okp01/images-custom/btn_edit.png" onmousemove="ToolTip.show(event, this, '\u004d\u0075\u006f\u006b\u006b\u0061\u0061\u0020\u006c\u0069\u006e\u006b\u006b\u0069\u00e4')" align="middle" border="0" />
									</a>
								</c:if>
								<portlet:actionURL var="removeFormURL">
									<portlet:param name="action" value="edit" />
									<portlet:param name="<%= EditController.EDIT_TYPE %>" value="<%= EditController.ADMIN_REMOVE_FORM_ACTION %>" />
									<portlet:param name="formId" value="<%= formId %>" />
									<portlet:param name="<%= EditController.CURRENT_CATEGORY %>" value="<%= currentCategory.getEntryId().toString() %>" />					
								</portlet:actionURL>
								<a href="${removeFormURL}">
									<img src="/html/themes/okp01/images-custom/btn_delete.png" onmousemove="ToolTip.show(event, this, '\u0050\u006f\u0069\u0073\u0074\u0061')" align="middle" border="0" />
								</a>
							</div>
						</td>
					</c:if>
				</tr>
			</c:forEach>
		</tbody>
	</table>
	<% } // Forms if ends
	
	/* Inform if there isn't any folders or forms */
	if (categories.size() == 0 && forms.size() == 0) {
		%>
		<div class="portlet-msg-error">T�ss� kansiossa ei ole lomakkeita eik� alikansioita.</div>
		<%
	}
	
	%>
	
	</div>
</div>