
<%@ include file="js_navigationState.jspf" %>
var kokuNavigationState = new KokuNavigationState;

function updateNavigationStatus(currentPosition, navigationState, callback) {
	var url="<%= naviStatusURL %>";
	url = formatUrl(url);
	var naviState = JSON.stringify(navigationState.getStatus());
	
	jQuery.post(url, {currentPosition: currentPosition, navigationState: naviState}, function(data) {
		var obj = jQuery.parseJSON(data);
		var naviState = obj.navigationState;
		koku_navi_type = obj.navigationPosition;
		if (typeof callback != 'undefined' && callback != null) {
			callback();
		}
	});
}

<% if (navigationPosition == null) { %> 
var koku_navi_type = null; 
<% } else { %> 
var koku_navi_type = '<%= navigationPosition %>';
<% } %>
if (!koku_navi_type) {
	updateNavigationStatus("", kokuNavigationState);
}

var defaultPath = "<%= defaultPath %>";
var naviRefreshTimer;
var kokuNaviSpeed = 150


	
jQuery(document).ready(function() {
	
	function openSavedNavigation() {
		// Find and close all #child elements 
		var data = '<%= navigationState %>';
		openSavedTreeNodes(data);	
	}
	
	jQuery('.child').hide();
	focusCurrentItem(koku_navi_type);	
	openSavedNavigation();
	ajaxUpdate();		
	clearInterval(naviRefreshTimer);	
});


/**
 * Finds the current item in navigation list and decorates the item, e.g. bold font 
 */
function focusCurrentItem(naviType) {

	function bold(elementId) {
	
		function getIndicatorElement(element) {
			if (typeof element == 'undefined' || element == null) {
				return;
			}
			return element.siblings('.naviLinkHeaderNonLink').children('.kokuNaviTreeNodeIndicator');			
		}
		
		function changeParentTreeIndicatorsToOpen(parentElement) {
			getIndicatorElement(parentElement).html('-');
		}
		
		function rememberCurrentOpenNode(element) {	
			if (typeof element == 'undefined' || element == null) {
				return;
			}
			
			var indicatorElements = getIndicatorElement(element);
			// FIXME! Does not work properly
			if (indicatorElements.length == 0 ) {
				// alert('BUG!');
				return;
			}
			var indicatorId = indicatorElements.get(0).attributes.id.value;
			var elemId = element.attr('id');		
			openKokuNavi('#'+elemId, '#'+indicatorId);
		}
	
		jQuery(elementId).css("font-weight", "bold");
		// Find and close all #child elements
		jQuery('.child').hide();
		// leave only elementId parent(s) open.
		var moreParents = true;
		var parentElement = jQuery(elementId).parent();
		if (parentElement == null) {
			return;
		}
		changeParentTreeIndicatorsToOpen(parentElement);
		rememberCurrentOpenNode(parentElement);
		
		var maxLoops = 0;
		while(moreParents && maxLoops <= 10) {
			if (parentElement.attr('id') === "koku-navigation") {
				moreParents = false;	
			} else {
				parentElement.show();
			}
			parentElement = parentElement.parent();
			changeParentTreeIndicatorsToOpen(parentElement);
			maxLoops++;
		}
	};

	/* Oh gosh.. this part really needs refactoring */

	var currentPage = "<%= currentPage %>";	
	switch(currentPage) {
		case '<%= defaultPage %>':		
			// var naviType = readKokuCookie();
			if(typeof naviType != 'undefined' && naviType != null && naviType != "") {
				bold("#"+naviType);
			} else {
				bold('#msg_inbox'); 
			}
			break;		
		case 'NewMessage' : bold('#msg_new'); break;
		case 'NewRequest' : bold('#req_new'); break;		
		case 'ValidRequest' : bold('#req_valid_request'); break;
		case 'NewAppointment' : bold('#app_new'); break;
		case 'NewKindergarten' : bold('#kid_new'); break;
		case 'ConfirmApplications' : bold('#applicationsConfirm'); break;
		case 'NewConsent' : bold('#cst_new'); break;
		case 'FillConsent' : bold('#fillconsent'); break;
		case 'SendConsent' : bold('#sendconsent'); break;	
		case 'SelaaValtakirjoja' : bold('#selaaOmiaValtakirjoja'); break;
		case 'Ilmoitukset' : bold('#info_request_open'); break;
		case 'DaycarePayments' : bold('#<%= Constants.TASK_TYPE_APPLICATION_DAYCARE_PAYMENT_BROWSE%>'); break;
		case 'DaycarePaymentsModify' : bold('#<%= Constants.TASK_TYPE_APPLICATION_DAYCARE_PAYMENT_MODIFY_BROWSE%>'); break;
		case 'DaycarePaymentsDiscounts' : bold('#<%= Constants.TASK_TYPE_APPLICATION_DAYCARE_PAYMENT_DISCOUNT_BROWSE%>'); break;
		case 'DaycareTermination' : bold('#<%= Constants.TASK_TYPE_APPLICATION_DAYCARE_TERMINATION_BROWSE%>'); break;
		case 'DaycareHolidays' : bold('#daycareHolidays'); break;
		case 'DaycarePayment' : bold('#daycareCustomerPayment'); break;
		case 'DaycarePaymentModify' : bold('#daycareCustomerPaymentModification'); break;
		case 'DaycarePaymentDiscounts' : bold('#daycareCustomerDiscount'); break;
		case 'DaycareTermination' : bold('#daycareCustomerTermination'); break;
		default: bold("#" + currentPage.toLowerCase()); break;
	}
};

/* Formats url mainly for gatein epp*/
	function formatUrl(url) {
		var newUrl;
		newUrl = url.replace(/&quot;/g,'"');
		newUrl = newUrl.replace(/&amp;/g,"&");
		newUrl = newUrl.replace(/&lt;/g,"<");
		newUrl =  newUrl.replace(/&gt;/g,">");
		return newUrl;
};

function escapeHTML(value) {
    return value.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

function openSavedTreeNodes(navigationState) {
	if (typeof navigationState == 'undefined' && navigationState == null) {
		return;
	}
	navigationStateParsed = JSON.parse(navigationState);
	var treeNode;
	var node;
	for (node in navigationStateParsed) {
		treeNode = navigationStateParsed[node];
		openKokuNavi(treeNode.toggleId, treeNode.indicatorId);
	}
}

/**
 * Execute ajax query in Post way, and parse the Json format response, and
 * then create tasks in table and task page filed.
 */
function ajaxUpdate() {	
	
	/**
	 * Updates the new message number to indicate user
	 */
	function updateMessageNum(inboxNum, archiveInboxNum, consentsTotal, appointmentsTotal, requestsTotal, infoRequestsTotal) {	
		
		function updateMsgCounter(elementId, count) {
			element = jQuery(elementId);
			if (count && !isNaN(count) && count != 0) {
				element.html('(' +count+')');
			} else if (count !== undefined && count != 0 && isNaN(count)) {
				element.html('(' + escapeHTML(count) + ')');
			} else {
				element.html("");
			}
		};
		
		updateMsgCounter('#inbox_num_super', parseInt(inboxNum, 10) + parseInt(archiveInboxNum, 10));
		updateMsgCounter('#inbox_num', inboxNum);
		updateMsgCounter('#archive_inbox_num_super', archiveInboxNum);
		updateMsgCounter('#archive_inbox_num', archiveInboxNum);
		updateMsgCounter('#requests_num_super_super', requestsTotal);
		updateMsgCounter('#requests_num_super', requestsTotal);
		updateMsgCounter('#requests_num', requestsTotal);
		updateMsgCounter('#appointments_num_super', appointmentsTotal);
		updateMsgCounter('#appointments_num', appointmentsTotal);
		updateMsgCounter('#consents_num_super', consentsTotal);
		updateMsgCounter('#consents_num', consentsTotal);
		updateMsgCounter('#infoRequests_num_super', infoRequestsTotal);
		updateMsgCounter('#infoRequests_num', infoRequestsTotal);
	};
	
	var url="<%= ajaxURL %>";
	url = formatUrl(url);
	
	jQuery.ajax({
		  type: 'POST',
		  url: url,
		  global:false,
		  // data: {navigationState: kokuNavigationState.getStatus()},
		  success: function(data) {
				var obj = jQuery.parseJSON(data);
				var json = obj.response;
				var navi_login_status = json["<%=Constants.JSON_LOGIN_STATUS %>"];
				// openSavedTreeNodes(obj.navigationState);
				
				if(navi_login_status == '<%=Constants.TOKEN_STATUS_VALID %>') {
					updateMessageNum(
							json["<%=Constants.JSON_INBOX %>"],
							json["<%=Constants.JSON_ARCHIVE_INBOX %>"],
							json["<%=Constants.JSON_CONSENTS_TOTAL %>"],
							json["<%=Constants.JSON_APPOINTMENT_TOTAL %>"],
							json["<%=Constants.JSON_REQUESTS_TOTAL %>"],
							json["<%=Constants.JSON_INFO_REQUESTS_TOTAL %>"]
						);
				}
				naviRefreshTimer = setTimeout('ajaxUpdate()', 30000);		
		  }
		});
};

function getMessageAmountIndicator(toggleId) {
	var receivedMessagesParentId;
	switch(toggleId) {
		case "#kokuNaviMessages":
			receivedMessagesParentId = "#inbox_num_super";
		break;
		case "#archive-part":
			receivedMessagesParentId = "#archive_inbox_num_super";
		break;
		case "#kokuNaviRequests":
			receivedMessagesParentId = "#requests_num_super_super";
		break;
		case "#kokuNaviRequestsRecevied":
			receivedMessagesParentId = "#requests_num_super";
		break;
		case "#kokuNaviInfoRequests":
			receivedMessagesParentId = "#infoRequests_num_super";
		break;
		case "#kokuNaviAppointment":
			receivedMessagesParentId = "#appointments_num_super";
		break;
		case "#kokuNaviConsents":
			receivedMessagesParentId = "#consents_num_super";
		break;
	}
	return receivedMessagesParentId;
}

function toggleKokuNavi(toggleId, indicatorId) {

	var indicator = jQuery(indicatorId);
	if (indicator.html() == "+") {
		openKokuNavi(toggleId, indicatorId);
	} else {
		closeKokuNavi(toggleId, indicatorId);
	}	
	updateNavigationStatus(koku_navi_type, kokuNavigationState);
}

function openKokuNavi(toggleId, indicatorId) {
	jQuery(toggleId).show(kokuNaviSpeed);
	var receivedMessagesParentId = getMessageAmountIndicator(toggleId);
	if (typeof receivedMessagesParentId != 'undefined' && receivedMessagesParentId != null) {
		jQuery(receivedMessagesParentId).hide(kokuNaviSpeed);
	}
	var indicator = jQuery(indicatorId);
	indicator.html('-');
	kokuNavigationState.add(toggleId, indicatorId);
}

function closeKokuNavi(toggleId, indicatorId, receivedMessagesParentId) {
	jQuery(toggleId).hide(kokuNaviSpeed);
	var receivedMessagesParentId = getMessageAmountIndicator(toggleId);
	if (typeof receivedMessagesParentId != 'undefined' && receivedMessagesParentId != null) {
		jQuery(receivedMessagesParentId).show(kokuNaviSpeed);
	}
	var indicator = jQuery(indicatorId);	
	indicator.html('+');
	kokuNavigationState.remove(toggleId);
}

function navigateToPage(naviType) {
	if (typeof kokuNavigationHelper === "undefined" || kokuNavigationHelper === null) {
		updateNavigationStatus(naviType, kokuNavigationState, function() {
			window.location = "<%= defaultPath %>" + "?resetView=true&NAVI_TYPE=" + naviType;
			return;
		});		
	}
	if (typeof kokuNavigationHelper.getHelperIdentifier() === "undefined") {
		/* console.error("Bug in code!! kokuNavigationHelper.getHelperIdentifier() is not defined!"); */
		return;
	}
	/* If navi_type is missing we are not in Message-portlet page ->  */
	updateNavigationStatus(naviType, kokuNavigationState, function() {	
		/* Update current position in navigation to server (session)  */
		switch(kokuNavigationHelper.getHelperIdentifier()) {
			case "MessagePortlet":
				window.location = kokuNavigationHelper.getReturnMainPageLink() + "&NAVI_TYPE=" + naviType;
				break;
			default:
				window.location = "<%= defaultPath %>" + "?resetView=true&NAVI_TYPE=" + naviType;
				break;
			}
	});
}
